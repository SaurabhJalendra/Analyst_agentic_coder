version: '3.8'

# Development Docker Compose - includes hot reload and volume mounts

services:
  # Backend API Service (Development)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: analyst-coder-backend-dev
    restart: unless-stopped
    environment:
      - CLAUDE_CODE_ACCESS_TOKEN=${CLAUDE_CODE_ACCESS_TOKEN}
      - CLAUDE_CODE_REFRESH_TOKEN=${CLAUDE_CODE_REFRESH_TOKEN}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-3-5-sonnet-20241022}
      - DEFAULT_REPO_URL=${DEFAULT_REPO_URL}
      - DEFAULT_REPO_BRANCH=${DEFAULT_REPO_BRANCH:-main}
      - GITHUB_ACCESS_TOKEN=${GITHUB_ACCESS_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - WORKSPACE_BASE_DIR=/app/workspaces
      - MAX_CONTEXT_LENGTH=${MAX_CONTEXT_LENGTH:-200000}
    volumes:
      # Mount source code for hot reload
      - ./backend/app:/app/app:ro
      # Persist workspaces
      - ./workspaces:/app/workspaces
      # Claude Code config
      - claude_config:/home/appuser/.claude
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    networks:
      - analyst-coder-network

  # Frontend React Application (Development)
  frontend:
    build:
      context: ./frontend-react
      dockerfile: Dockerfile.dev
    container_name: analyst-coder-frontend-dev
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://localhost:8000
    volumes:
      # Mount source code for hot reload
      - ./frontend-react/src:/app/src:ro
      - ./frontend-react/public:/app/public:ro
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      - backend
    networks:
      - analyst-coder-network

volumes:
  claude_config:
    driver: local

networks:
  analyst-coder-network:
    driver: bridge
